<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.icia.aboard2.dao.BoardRepository"> 
	<select id="count" resultType="int">
		select /*+ index_ffs(board_pk_bno) */ count(bno) from board
	</select>
	<select id="listAll" resultType="com.icia.aboard2.dto.BoardDto$ListBoard">
		select bno,title,writer,write_date writeDate,read_cnt readCnt,reply_cnt replyCnt from board
	</select>
	<select id="list" resultType="com.icia.aboard2.dto.BoardDto$ListBoard">
	<![CDATA[

    	select * from
        	(select rownum rnum, b.* from 
            	(select /*+ index_desc(board board_pk_bno) */ bno, writer, title, write_date writeDate, 
            	read_cnt readCnt, recommend_cnt recommendCnt, reply_cnt replyCnt from board where categori_name=#{categoriName} order by bno desc
            	) b
        	where rownum<=#{endRow}) 
    	where rnum>=#{startRow}
    	order by bno desc
	]]> 
	</select>

	<!-- 1.1 글 읽을 때 조회수 증가 -->	
	<update id="increaseReadCnt">
		update board set read_cnt = read_cnt+1 where bno = #{bno} and rownum=1
	</update>
	<!-- 1.2 글 읽기 -->
	<select id="read" resultType="hashmap">
		<![CDATA[
			select bno, title, content, writer, write_date writeDate, read_cnt readCnt,
			recommend_cnt recommendCnt, report_cnt reportCnt from board where categori_name=#{categoriName} and bno=#{bno} and rownum = 1
			
		]]>
	</select>
	<insert id="write" useGeneratedKeys="true" keyProperty="bno">
		<selectKey keyProperty="bno" resultType="int" order="BEFORE">
			select board_seq.nextval from dual
		</selectKey>
		insert into board(bno, title, content, writer, write_date, read_cnt, recommend_cnt, report_cnt, reply_cnt,categori_name) 
		values(#{bno},#{title},#{content},#{writer}, sysdate, 0,0,0,0,#{categoriName})
	</insert>
	
	<!--  추천 -->
	<update id="recommend">
		update board set recommend_cnt = recommend_cnt+1 where bno = #{bno} and rownum=1
	</update>
	
	<select id="getRecommendCnt" resultType="int">
		select recommend_cnt from board where bno=#{bno} and rownum=1
	</select>
	
	<!-- 신고 -->
	<update id="report">
		update board set recommend_cnt = recommend_cnt+1 where bno = #{bno} and rownum=1
	</update>
	
	<select id="getReportCnt" resultType="int">
		select report_cnt from board where bno=#{bno} and rownum=1
	</select>
	<delete id="delete" parameterType="int">
		delete from board where bno=#{bno}
	</delete>
	<!-- 댓글갯수증가 -->
	<update id="upReplyCnt" parameterType="int">
		update board set reply_cnt = reply_cnt+1 where bno = #{bno} and rownum=1
	
	</update>
</mapper>





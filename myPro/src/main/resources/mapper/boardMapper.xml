<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myPro.dao.BoardRepository"> 
	<!-- 전체 게시판 글 갯수 -->
	<select id="bCountAll" resultType="int" parameterType="string">
		select /*+ index_ffs(board_pk_bno) */ count(bno) from board where categori_name = #{categoriName}
	</select>
	<!-- 검색 게시판 글 갯수 -->
	<select id="bSearchCnt" resultType="int" parameterType="string">
		select /*+ index_ffs(board_pk_bno) */ count(bno) from board where title like '%'||#{search}||'%' and categori_name = #{categoriName}
	</select>
	<!-- 리스트 -->
	<select id="bList" resultType="com.myPro.dto.BoardDto$ListBoard">
	<![CDATA[

    	select * from
        	(select rownum rnum, b.* from 
            	(select /*+ index_desc(board board_pk_bno) */ bno, writer, title, write_date writeDate, 
            	read_cnt readCnt, recommend_cnt recommendCnt, reply_cnt replyCnt from board where categori_name=#{categoriName} order by bno desc
            	) b
        	where rownum<=#{endRow}) 
    	where rnum>=#{startRow}
    	order by bno desc
	]]> 
	</select>
	<!-- 글 읽을 때 조회수 증가 -->	
	<update id="bUpReadCnt">
		update board set read_cnt = read_cnt+1 where bno = #{bno} and rownum=1
	</update>
	<!--  추천 -->
	<update id="bRecommend">
		update board set recommend_cnt = recommend_cnt+1 where bno = #{bno} and rownum=1
	</update>
	<update id="bUnRecommend">
		update board set recommend_cnt = recommend_cnt-1 where bno = #{bno} and rownum=1
	</update>
	<!-- 추천횟수 -->
	<select id="bRecommendCnt" resultType="int">
		select recommend_cnt from board where bno=#{bno} and rownum=1
	</select>
	<!-- 글 읽기 -->
	<select id="bRead" resultType="hashmap">
		<![CDATA[
			select bno, title, content, writer, write_date writeDate, read_cnt readCnt,
			recommend_cnt recommendCnt, report_cnt reportCnt from board where categori_name=#{categoriName} and bno=#{bno} and rownum = 1
			
		]]>
	</select>
	<!-- 글쓰기 -->
	<insert id="bWrite" useGeneratedKeys="true" keyProperty="bno">
		<selectKey keyProperty="bno" resultType="int" order="BEFORE">
			select board_seq.nextval from dual
		</selectKey>
		insert into board(bno, title, content, writer, write_date, read_cnt, recommend_cnt, report_cnt, reply_cnt,categori_name) 
		values(#{bno},#{title},#{content},#{writer}, sysdate, 0,0,0,0,#{categoriName})
	</insert>
	<!-- 글수정 -->
	<update id="bUpdate" parameterType="string">
		update board set title=#{title},content=#{content} where bno=#{bno}
	</update>
	<!-- 글 삭제 -->
	<delete id="bDelete" parameterType="string">
		delete from board where bno=#{bno} and categori_name=#{categoriName}
	</delete>
	<!-- 자신의 글 확인-->
	<select id="bMyWriteSearch" resultType="string" parameterType="string">
		select bno from board where bno=#{bno} and writer=#{writer}
	</select>
	<!-- 댓글갯수증가 -->
	<update id="bUpReplyCnt" parameterType="int">
		update board set reply_cnt = reply_cnt+1 where bno = #{bno} and rownum=1
	
	</update>
	<!-- 글 검색 -->
	<select id="bBoardSearch" resultType="com.myPro.dto.BoardDto$ListBoard">
	<![CDATA[

    	select * from
        	(select rownum rnum, b.* from 
            	(select /*+ index_desc(board board_pk_bno) */ bno, writer, title, write_date writeDate, 
            	read_cnt readCnt, recommend_cnt recommendCnt, reply_cnt replyCnt from board where title like '%'||#{search}||'%' and categori_name=#{categoriName} order by bno desc
            	) b
        	where rownum<=#{endRow}) 
    	where rnum>=#{startRow}
    	order by bno desc
	]]> 
	</select>
	<!-- 누구글인지 확인 -->
	<select id="bBoardWriter" resultType="string" >
		select writer from board where bno=#{bno}
	</select>
</mapper>




